<?php

/**
 * Content
 *
 * This class has been auto-generated by the Doctrine ORM Framework
 *
 * @package    demofony
 * @subpackage model
 * @author     Marc Montañés <marc@teclliure.net>
 * @version    SVN: $Id: Builder.php 7691 2011-02-04 15:43:29Z jwage $
 */
class Content extends BaseContent
{
  public function addView() {
    $this->setViews($this->getViews() + 1);
    $this->save();
  }
  
  public function hasOpinated($user) {
    $query = Doctrine::getTable('OpinionLike')->createQuery('ol')->leftJoin('ol.Opinion o')->where('o.object_class = ?',get_class($this))->andWhere('o.object_id = ?',$this->getId())->where('ol.user_id = ?',$user->getId());
    $opinionLike = $query->count();
    $query = Doctrine::getTable('Opinion')->createQuery('o')->where('o.object_class = ?',get_class($this))->andWhere('o.object_id = ?',$this->getId())->andWhere('o.user_id = ?',$user->getId());
    $opinion = $query->count();
    
    if ($opinion || $opinionLike) {
      return true;
    }
    else {
      return false;
    }
  }

  public function getOpinion($user) {
    $query = Doctrine::getTable('OpinionLike')->createQuery('ol')->leftJoin('ol.Opinion o')->where('o.object_class = ?',get_class($this))->andWhere('o.object_id = ?',$this->getId())->where('ol.user_id = ?',$user->getId());
    $opinion = $query->execute()->getFirst();
    if (!$opinion) {
      $query = Doctrine::getTable('Opinion')->createQuery('o')->where('o.object_class = ?',get_class($this))->andWhere('o.object_id = ?',$this->getId())->andWhere('o.user_id = ?',$user->getId());
      $opinion = $query->execute()->getFirst();
    }
    
    if ($opinion) {
      return $opinion;
    }
    else {
      return false;
    }
  }
  
  public function getOpinions() {
    $query = Doctrine::getTable('Opinion')->createQuery('o')->where('o.object_class = ?',get_class($this))->andWhere('o.object_id = ?',$this->getId());
    return $query->execute();
  }
  
  public function countOpinions() {
    $query = Doctrine::getTable('Opinion')->createQuery('o')->where('o.object_class = ?',get_class($this))->andWhere('o.object_id = ?',$this->getId());
    return $query->count();
  }
  
  public function countAllOpinions() {
    $query = Doctrine::getTable('OpinionLike')->createQuery('ol')->leftJoin('ol.Opinion o')->where('o.object_class = ?',get_class($this))->andWhere('o.object_id = ?',$this->getId());
    $numOpinions = $query->count();
    $query = Doctrine::getTable('Opinion')->createQuery('o')->where('o.object_class = ?',get_class($this))->andWhere('o.object_id = ?',$this->getId());
    $numOpinions += $query->count();
    return $numOpinions;
  }
}
